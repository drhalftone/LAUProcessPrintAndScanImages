#version 330 core

// THIS FRAGMENT SHADER TAKES 1 INPUT ROW AND EXPANDS IT TO 8 OUTPUT ROWS
// EACH OUTPUT ROW CORRESPONDS TO THE 1 INPUT ROW BEING CONVOLVED WITH A
// DIFFERENT 16-WEIGHT FIR FILTER.

// SET THE NUMBER OF FILTERS AND THE LENGTH OF EACH IN WEIGHTS
#define NUMFILTERS  8
#define LENFILTERS 16

uniform sampler2D qt_texture;  // THIS TEXTURE HOLDS THE XYZ+TEXTURE COORDINATES

// DEFINE THE CONVOLUTIONAL FILTER WEIGHTS
const float weights[128] = float[128](  0.038045, -0.020262, -0.061388, 0.037842, 0.051962, -0.031916, -0.006036, 0.012512, -0.002981, -0.023767, 0.008837, 0.043855, -0.022124, -0.043723, 0.030512, 0.004443,
                                        0.001395, 0.028294, 0.026652, -0.044655, 0.003773, 0.038716, -0.011746, -0.008658, 0.031034, 0.003792, -0.066155, -0.004765, 0.073174, -0.017495, -0.052597, 0.013332,
                                        -1.400741, -1.534119, -1.327583, 1.376922, 1.506434, -1.079103, -1.434121, -1.631758, 1.370118, 1.459254, -1.539243, -1.501867, -1.061008, 1.557662, 1.307750, -1.681810,
                                        -1.752276, -1.501471, -1.411913, 1.443130, 1.587088, 1.726695, -1.309023, -1.501521, -1.556640, 1.346104, 1.358274, -1.301207, -1.409686, -1.384391, 1.464332, 1.493894,
                                        1.439877, 1.583972, 1.584688, -1.237187, -1.507026, -1.952357, 1.289949, 1.444561, -1.376646, -1.348740, 1.829011, 1.534818, 1.054977, -1.545586, -1.356654, 1.690287,
                                        0.028260, 0.006153, -0.017048, -0.005731, 0.034676, 0.010781, -0.011410, 0.006139, 0.019893, 0.001295, -0.041818, 0.036174, 0.064035, -0.068323, -0.034607, 0.043696,
                                        1.282769, -1.592654, -1.424460, -1.336269, 1.533388, 1.473863, 1.313335, -1.535288, -1.481416, -1.367336, 1.584428, 1.478494, 1.356938, -1.334444, -1.431802, -1.362790,
                                        0.028168, -0.043103, 0.004067, 0.054497, -0.030918, -0.027408, 0.072534, 0.013956, -0.071898, 0.009801, 0.050624, -0.020102, -0.039226, 0.022672, 0.014066, -0.031039);

layout(location = 0, index = 0) out vec4 qt_fragColor;

void main()
{
    // GET THE CURRENT FRAGMENT COORDINATE IN PIXELS
    ivec2 position = ivec2(gl_FragCoord.xy);

    // FIGURE OUT WHAT FILTER WE WANT BASED ON THE OUTPUT ROW COORDINATE
    int index = position.y % NUMFILTERS;

    // INITIALIZE THE OUTPUT PIXEL TO THE FIRST PIXEL IN THE SWATH    
    qt_fragColor = vec4(0.0, 0.0, 0.0, 0.0);
    for (int c = 0; c < LENFILTERS; c++){
        qt_fragColor += weights[index * LENFILTERS + c] * texelFetch(qt_texture, ivec2(gl_FragCoord.x - c, gl_FragCoord.y/NUMFILTERS), 0);
    }
}
